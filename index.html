<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bozorlik AI ¬∑ Smart Bazaar Assistant</title>

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* =============================================
           BOZORLIK AI 3.0 ¬∑ PREMIUM DESIGN SYSTEM
           Telegram Mini App Native Experience
           Mobile-First ¬∑ Glassmorphism ¬∑ Micro-interactions
        ============================================= */

        /* ---------- DESIGN TOKENS ---------- */
        :root {
            /* Orange ‚Äî Primary Brand Color */
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-200: #fed7aa;
            --orange-300: #fdba74;
            --orange-400: #fb923c;
            --orange-500: #f97316;
            --orange-600: #ea580c;
            --orange-700: #c2410c;
            --orange-800: #9a3412;
            --orange-900: #7c2d12;
            --orange-950: #431407;

            /* Primary Orange - Signature */
            --primary: #f97316;
            --primary-light: #fb923c;
            --primary-dark: #ea580c;
            --primary-gradient: linear-gradient(145deg, #f97316, #fb923c);
            --primary-soft-gradient: linear-gradient(145deg, rgba(249,115,22,0.12), rgba(251,146,60,0.12));
            --primary-glow: 0 8px 20px -6px rgba(249,115,22,0.3);

            /* Neutral - Light Mode */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --surface-primary: #ffffff;
            --surface-secondary: #fafafa;
            --surface-tertiary: #f5f5f5;
            --surface-elevated: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.8);

            --text-primary: #171717;
            --text-secondary: #525252;
            --text-tertiary: #a3a3a3;
            --text-disabled: #d4d4d4;
            --text-on-primary: #ffffff;
            --text-on-dark: #ffffff;

            --border-light: #e5e5e5;
            --border-medium: #d4d4d4;
            --border-focused: #f97316;

            --shadow-xs: 0 2px 4px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-sm: 0 4px 6px -2px rgba(0,0,0,0.03), 0 2px 4px -1px rgba(0,0,0,0.02);
            --shadow-md: 0 10px 15px -6px rgba(0,0,0,0.04), 0 4px 6px -2px rgba(0,0,0,0.02);
            --shadow-lg: 0 20px 25px -8px rgba(0,0,0,0.05), 0 8px 10px -4px rgba(0,0,0,0.02);
            --shadow-xl: 0 30px 40px -12px rgba(0,0,0,0.08);
            --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.02);

            /* Dark Mode Variables - Pure Black & Orange */
            --dark-bg-primary: #000000;
            --dark-bg-secondary: #0a0a0a;
            --dark-bg-tertiary: #141414;
            --dark-surface-primary: #0d0d0d;
            --dark-surface-secondary: #1a1a1a;
            --dark-surface-tertiary: #262626;
            --dark-surface-elevated: #1f1f1f;
            --dark-surface-glass: rgba(10, 10, 10, 0.9);

            --dark-text-primary: #ffffff;
            --dark-text-secondary: #a3a3a3;
            --dark-text-tertiary: #737373;
            --dark-text-disabled: #404040;

            --dark-border-light: #262626;
            --dark-border-medium: #404040;
            --dark-border-focused: #f97316;

            --dark-shadow-xs: 0 2px 4px rgba(0,0,0,0.4);
            --dark-shadow-sm: 0 4px 6px rgba(0,0,0,0.5);
            --dark-shadow-md: 0 10px 15px rgba(0,0,0,0.6);
            --dark-shadow-lg: 0 20px 25px rgba(0,0,0,0.7);
            --dark-shadow-xl: 0 30px 40px rgba(0,0,0,0.8);

            /* Spacing System */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --text-xs: 11px;
            --text-sm: 13px;
            --text-base: 15px;
            --text-lg: 17px;
            --text-xl: 19px;
            --text-2xl: 21px;
            --text-3xl: 25px;
            --text-4xl: 29px;
            --text-5xl: 35px;

            /* Border Radius */
            --radius-xs: 6px;
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* Animation */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Layout */
            --header-height: 72px;
            --bottom-nav-height: 84px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-top: env(safe-area-inset-top, 0px);

            /* Z-index */
            --z-bottom-nav: 100;
            --z-modal: 200;
            --z-dropdown: 300;
            --z-tooltip: 400;
            --z-toast: 500;
            --z-list-modal: 600;
        }

        /* ---------- DARK MODE ---------- */
        body.dark {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-tertiary: var(--dark-bg-tertiary);
            --surface-primary: var(--dark-surface-primary);
            --surface-secondary: var(--dark-surface-secondary);
            --surface-tertiary: var(--dark-surface-tertiary);
            --surface-elevated: var(--dark-surface-elevated);
            --surface-glass: var(--dark-surface-glass);

            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-tertiary: var(--dark-text-tertiary);
            --text-disabled: var(--dark-text-disabled);

            --border-light: var(--dark-border-light);
            --border-medium: var(--dark-border-medium);
            --border-focused: var(--dark-border-focused);

            --shadow-xs: var(--dark-shadow-xs);
            --shadow-sm: var(--dark-shadow-sm);
            --shadow-md: var(--dark-shadow-md);
            --shadow-lg: var(--dark-shadow-lg);
            --shadow-xl: var(--dark-shadow-xl);
        }

        /* ---------- RESET & BASE ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        /* ---------- GLASS BACKGROUND EFFECT ---------- */
        .glass-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 0% 0%, rgba(249,115,22,0.03) 0%, transparent 50%),
                radial-gradient(circle at 100% 30%, rgba(251,146,60,0.03) 0%, transparent 50%),
                radial-gradient(circle at 20% 70%, rgba(249,115,22,0.02) 0%, transparent 50%),
                radial-gradient(circle at 80% 90%, rgba(251,146,60,0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        body.dark .glass-background {
            background:
                radial-gradient(circle at 0% 0%, rgba(249,115,22,0.05) 0%, transparent 60%),
                radial-gradient(circle at 100% 30%, rgba(251,146,60,0.05) 0%, transparent 60%),
                radial-gradient(circle at 20% 70%, rgba(249,115,22,0.04) 0%, transparent 60%),
                radial-gradient(circle at 80% 90%, rgba(251,146,60,0.04) 0%, transparent 60%);
        }

        /* ---------- MAIN CONTAINER ---------- */
        .main-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
            position: relative;
            z-index: 1;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            height: 100%;
        }

        .main-container::-webkit-scrollbar {
            width: 4px;
        }

        .main-container::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        .main-container::-webkit-scrollbar-track {
            background: transparent;
        }

        /* ---------- BOTTOM NAVIGATION ---------- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
            padding-bottom: var(--safe-area-bottom);
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: var(--z-bottom-nav);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }

        body.dark .bottom-nav {
            border-top: 1px solid var(--dark-border-light);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 0;
            flex: 1;
            color: var(--text-tertiary);
            transition: var(--transition-base);
            position: relative;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
            position: relative;
            transition: var(--transition-bounce);
        }

        .nav-item.active .nav-icon {
            transform: translateY(-2px);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .nav-indicator {
            position: absolute;
            bottom: -8px;
            width: 4px;
            height: 4px;
            border-radius: var(--radius-full);
            background: var(--primary);
            opacity: 0;
            transition: var(--transition-base);
        }

        .nav-item.active .nav-indicator {
            opacity: 1;
            width: 24px;
            bottom: -4px;
        }

        /* ---------- TAB CONTENT ---------- */
        .tab-content {
            display: none;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ---------- HEADER ---------- */
        .header {
            padding: var(--space-5) var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: transparent;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background: var(--surface-glass);
            border-bottom: 1px solid var(--border-light);
        }

        .header-title {
            font-size: var(--text-xl);
            font-weight: 700;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .header-title i {
            color: var(--primary);
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: var(--space-3);
        }

        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 18px;
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .icon-button:hover {
            background: var(--surface-tertiary);
            color: var(--primary);
            border-color: var(--primary-light);
            transform: scale(0.95);
        }

        /* ---------- ANALYTICS TAB ---------- */
        .analytics-container {
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
            height: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .stat-card {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            border: 1px solid var(--border-light);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition-base);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            background: var(--primary-soft-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 22px;
            margin-bottom: var(--space-4);
        }

        .stat-value {
            font-size: var(--text-3xl);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-trend {
            margin-top: var(--space-3);
            font-size: var(--text-xs);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-tertiary);
        }

        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }

        /* ---------- CHART CONTAINER ---------- */
        .chart-card {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            border: 1px solid var(--border-light);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .chart-title {
            font-size: var(--text-lg);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chart-title i {
            color: var(--primary);
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
            width: 100%;
        }

        /* ---------- INSIGHTS CARD ---------- */
        .insights-card {
            background: var(--primary-gradient);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .insights-card::after {
            content: '‚ú®';
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 120px;
            opacity: 0.1;
        }

        .insights-title {
            font-size: var(--text-lg);
            font-weight: 700;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .insights-text {
            font-size: var(--text-base);
            line-height: 1.6;
            opacity: 0.95;
            margin-bottom: var(--space-4);
        }

        .insights-meta {
            font-size: var(--text-xs);
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        /* ---------- EMPTY STATES ---------- */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-16) var(--space-6);
            text-align: center;
        }

        .empty-illustration {
            font-size: 80px;
            margin-bottom: var(--space-6);
            opacity: 0.5;
        }

        .empty-title {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--space-3);
            color: var(--text-primary);
        }

        .empty-description {
            font-size: var(--text-base);
            color: var(--text-secondary);
            max-width: 280px;
            margin-bottom: var(--space-6);
        }

        .empty-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: var(--text-base);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            box-shadow: var(--primary-glow);
            transition: var(--transition-bounce);
            cursor: pointer;
        }

        .empty-button:hover {
            transform: scale(0.97);
            box-shadow: none;
        }

        /* ===== –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ß–ê–¢ ===== */
        /* ---------- CHAT TAB ---------- */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: var(--space-6) var(--space-6) var(--space-4) var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            scroll-behavior: smooth;
            min-height: 0;
            height: 0; /* –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã flex */
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-bubble {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl);
            font-size: var(--text-base);
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
            box-shadow: var(--primary-glow);
        }

        .message.ai .message-bubble {
            background: var(--surface-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-time {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: var(--space-2);
            margin-left: var(--space-2);
            margin-right: var(--space-2);
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ---------- TYPING INDICATOR ---------- */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: var(--space-4) var(--space-5);
            background: var(--surface-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            border-bottom-left-radius: var(--radius-sm);
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: var(--radius-full);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ---------- SHOPPING LIST ---------- */
        .shopping-list {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            border: 1px solid var(--border-light);
            margin-top: var(--space-4);
        }

        .list-category {
            margin-bottom: var(--space-5);
        }

        .list-category:last-child {
            margin-bottom: 0;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border-light);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 700;
            color: var(--text-primary);
        }

        .category-total {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-soft-gradient);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
        }

        .list-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface-primary);
            border-radius: var(--radius-lg);
            border: 1px solid transparent;
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .list-item:hover {
            background: var(--surface-tertiary);
            border-color: var(--border-light);
        }

        .list-item.purchased {
            opacity: 0.6;
            background: var(--surface-secondary);
        }

        .list-item.purchased .item-name {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .item-checkbox {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            flex-shrink: 0;
        }

        .item-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .item-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .item-content {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .item-details {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .item-price {
            font-weight: 700;
            color: var(--primary);
        }

        .item-actions {
            display: none;
            gap: var(--space-2);
        }

        .list-item:hover .item-actions {
            display: flex;
        }

        .item-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            background: var(--surface-primary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .item-action-btn:hover {
            background: var(--surface-tertiary);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* ---------- CHAT INPUT - –í–°–ï–ì–î–ê –í–ò–î–ò–ú–´–ô ---------- */
        .chat-input-container {
            padding: var(--space-4) var(--space-6) calc(var(--space-4) + var(--safe-area-bottom));
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-3);
            align-items: center;
            position: relative;
            z-index: 20;
            flex-shrink: 0;
            width: 100%;
            margin-top: auto; /* –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border-radius: var(--radius-full);
            border: 1.5px solid var(--border-light);
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: var(--text-base);
            font-family: var(--font-family);
            transition: var(--transition-fast);
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .chat-input-actions {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: var(--space-2);
        }

        .chat-input-action {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chat-input-action:hover {
            background: var(--surface-tertiary);
            color: var(--primary);
        }

        .voice-button, .send-button {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition-bounce);
            flex-shrink: 0;
        }

        .voice-button {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border: 1.5px solid var(--border-light);
        }

        .voice-button.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }

        .send-button {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--primary-glow);
        }

        .send-button:hover {
            transform: scale(0.95);
            box-shadow: none;
        }

        /* ---------- PROFILE TAB ---------- */
        .profile-container {
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
            height: auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--space-5);
            padding: var(--space-6);
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-light);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 700;
            border: 3px solid var(--surface-primary);
            box-shadow: var(--shadow-md);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
            color: var(--text-primary);
        }

        .profile-id {
            font-size: var(--text-sm);
            color: var(--text-tertiary);
            font-family: monospace;
            margin-bottom: var(--space-2);
        }

        .profile-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--primary-soft-gradient);
            border-radius: var(--radius-full);
            color: var(--primary);
            font-size: var(--text-xs);
            font-weight: 600;
        }

        /* ---------- SETTINGS SECTION ---------- */
        .settings-section {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .settings-header {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: 700;
            color: var(--text-primary);
        }

        .settings-header i {
            color: var(--primary);
        }

        .settings-list {
            padding: var(--space-2);
            max-height: 400px;
            overflow-y: auto;
        }

        .settings-list::-webkit-scrollbar {
            width: 4px;
        }

        .settings-list::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-lg);
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .settings-item:hover {
            background: var(--surface-tertiary);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .settings-item-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--surface-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .settings-item-subtitle {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        .settings-item-value {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* ---------- TOGGLE SWITCH ---------- */
        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--border-medium);
            border-radius: var(--radius-full);
            position: relative;
            transition: var(--transition-base);
            cursor: pointer;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: var(--radius-full);
            position: absolute;
            top: 2px;
            left: 2px;
            transition: var(--transition-bounce);
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch.active .toggle-slider {
            left: 26px;
        }

        /* ---------- FAQ ACCORDION ---------- */
        .faq-item {
            border-bottom: 1px solid var(--border-light);
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-question {
            padding: var(--space-5) var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .faq-question:hover {
            background: var(--surface-tertiary);
        }

        .faq-question-text {
            font-weight: 600;
            color: var(--text-primary);
        }

        .faq-answer {
            padding: 0 var(--space-6) var(--space-5) var(--space-6);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            line-height: 1.6;
            display: none;
        }

        .faq-item.active .faq-answer {
            display: block;
        }

        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }

        /* ---------- MODALS ---------- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--surface-elevated);
            border-radius: var(--radius-2xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: var(--text-xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--surface-tertiary);
            color: var(--text-primary);
        }

        .modal-content {
            padding: var(--space-6);
            overflow-y: auto;
        }

        .modal-footer {
            padding: var(--space-6);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-4);
        }

        /* ---------- LIST DETAIL MODAL ---------- */
        .list-detail-modal {
            z-index: var(--z-list-modal);
        }

        .list-detail-content {
            padding: var(--space-6);
            max-height: 60vh;
            overflow-y: auto;
        }

        .list-detail-content::-webkit-scrollbar {
            width: 4px;
        }

        .list-detail-content::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        .list-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--border-light);
        }

        .list-detail-date {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .list-detail-total {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--primary);
        }

        /* ---------- LANGUAGE SELECTOR ---------- */
        .language-option {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1.5px solid var(--border-light);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .language-option:hover {
            border-color: var(--primary);
            background: var(--primary-soft-gradient);
        }

        .language-option.active {
            border-color: var(--primary);
            background: var(--primary-soft-gradient);
        }

        .language-flag {
            font-size: 28px;
        }

        .language-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ---------- EXPENSE PROMPT ---------- */
        .expense-prompt {
            background: var(--surface-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            border: 1px solid var(--border-light);
            margin-top: var(--space-4);
        }

        .expense-title {
            font-size: var(--text-lg);
            font-weight: 700;
            margin-bottom: var(--space-3);
            color: var(--primary);
        }

        .expense-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .analytics-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
            transition: var(--transition-bounce);
        }

        .analytics-button:hover {
            transform: scale(0.97);
        }

        /* ---------- TOAST NOTIFICATIONS ---------- */
        .toast {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface-elevated);
            color: var(--text-primary);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: 500;
            z-index: var(--z-toast);
            opacity: 0;
            transition: var(--transition-bounce);
            pointer-events: none;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast i {
            color: var(--primary);
        }

        /* ---------- UTILITIES ---------- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .mt-1 { margin-top: var(--space-2); }
        .mt-2 { margin-top: var(--space-4); }
        .mt-3 { margin-top: var(--space-6); }
        .mt-4 { margin-top: var(--space-8); }

        .mb-1 { margin-bottom: var(--space-2); }
        .mb-2 { margin-bottom: var(--space-4); }
        .mb-3 { margin-bottom: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-8); }

        /* ---------- RESPONSIVE ADJUSTMENTS ---------- */
        @media (max-width: 380px) {
            :root {
                --bottom-nav-height: 74px;
                --space-6: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-avatar {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Glass Background Effect -->
        <div class="glass-background"></div>

        <!-- Main Container -->
        <div class="main-container" id="mainContainer">
            <!-- Analytics Tab -->
            <div class="tab-content active" id="analyticsTab">
                <div class="header">
                    <div class="header-title">
                        <i class="fas fa-chart-line"></i>
                        <span data-i18n="analytics.title">Analytics</span>
                    </div>
                    <div class="header-actions">
                        <button class="icon-button" id="themeToggle">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>

                <div class="analytics-container" id="analyticsContent">
                    <!-- Loading State -->
                    <div class="empty-state" id="analyticsLoading">
                        <div class="empty-illustration">
                            <i class="fas fa-circle-notch fa-spin" style="color: var(--primary);"></i>
                        </div>
                        <div class="empty-title" data-i18n="analytics.loading">Loading analytics...</div>
                        <div class="empty-description" data-i18n="analytics.loadingDesc">Please wait while we fetch your data</div>
                    </div>

                    <!-- Analytics Content (hidden by default) -->
                    <div id="analyticsData" style="display: none;">
                        <!-- Stats Grid will be populated by JS -->
                        <div class="stats-grid" id="statsGrid"></div>

                        <!-- Spending Chart -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-chart-pie"></i>
                                    <span data-i18n="analytics.categoryDistribution">Category Distribution</span>
                                </div>
                                <div class="chart-legend" id="chartLegend"></div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="spendingChart"></canvas>
                            </div>
                        </div>

                        <!-- AI Insights -->
                        <div class="insights-card" id="insightsCard">
                            <div class="insights-title">
                                <i class="fas fa-robot"></i>
                                <span data-i18n="analytics.aiInsights">AI Insights</span>
                            </div>
                            <div class="insights-text" id="insightsText">
                                You haven't made any purchases yet. Start by creating your first shopping list!
                            </div>
                            <div class="insights-meta">
                                <span><i class="far fa-clock"></i> <span id="insightsTime">Updated just now</span></span>
                                <span><i class="fas fa-chart-simple"></i> AI Powered</span>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="settings-section">
                            <div class="settings-header">
                                <i class="fas fa-history"></i>
                                <span data-i18n="analytics.recentActivity">Recent Activity</span>
                            </div>
                            <div class="settings-list" id="recentActivityList">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Empty State (shown when no data) -->
                    <div class="empty-state" id="analyticsEmpty" style="display: none;">
                        <div class="empty-illustration">
                            üìä
                        </div>
                        <div class="empty-title" data-i18n="analytics.emptyTitle">No data yet</div>
                        <div class="empty-description" data-i18n="analytics.emptyDesc">
                            Create your first shopping list to see analytics and insights
                        </div>
                        <button class="empty-button" onclick="window.switchToChat()">
                            <i class="fas fa-shopping-basket"></i>
                            <span data-i18n="analytics.createList">Create List</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-content" id="chatTab">
                <div class="chat-container">
                    <div class="header">
                        <div class="header-title">
                            <!-- –ò–∫–æ–Ω–∫–∞ Signal Messenger –≤ –æ—Ä–∞–Ω–∂–µ–≤–æ–º —Ü–≤–µ—Ç–µ -->
                            <i class="fa-brands fa-signal-messenger" style="color: #f97316;"></i>
                            <span data-i18n="chat.title">Bozorlik AI</span>
                        </div>
                        <div class="header-actions">
                            <button class="icon-button" id="chatThemeToggle">
                                <i class="fas fa-moon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Welcome message will be added by JS -->
                    </div>

                    <div class="chat-input-container">
                        <button class="voice-button" id="voiceButton">
                            <i class="fas fa-microphone"></i>
                        </button>

                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input" id="chatInput"
                                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫..."
                                   autocomplete="off">
                            <div class="chat-input-actions">
                                <button class="chat-input-action" id="clearChatInput">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <button class="send-button" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="profileTab">
                <div class="header">
                    <div class="header-title">
                        <i class="fas fa-user-circle"></i>
                        <span data-i18n="profile.title">Profile</span>
                    </div>
                    <div class="header-actions">
                        <button class="icon-button" id="profileThemeToggle">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>

                <div class="profile-container">
                    <!-- Telegram Profile Info -->
                    <div class="profile-header" id="telegramProfile">
                        <div class="profile-avatar" id="profileAvatar">
                            <span id="avatarInitials">BZ</span>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName">Telegram User</div>
                            <div class="profile-id" id="profileId">Loading...</div>
                            <div class="profile-badge">
                                <i class="fas fa-check-circle"></i>
                                <span data-i18n="profile.verified">Verified</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="settings-section">
                        <div class="settings-header">
                            <i class="fas fa-sliders-h"></i>
                            <span data-i18n="profile.settings">Settings</span>
                        </div>
                        <div class="settings-list">
                            <!-- Language Switcher -->
                            <div class="settings-item" onclick="openLanguageModal()">
                                <div class="settings-item-left">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div class="settings-item-content">
                                        <div class="settings-item-title" data-i18n="profile.language">Language</div>
                                        <div class="settings-item-subtitle" data-i18n="profile.languageDesc">Choose your preferred language</div>
                                    </div>
                                </div>
                                <div class="settings-item-value" id="currentLanguage">
                                    –†—É—Å—Å–∫–∏–π
                                </div>
                            </div>

                            <!-- Theme Toggle -->
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                    <div class="settings-item-content">
                                        <div class="settings-item-title" data-i18n="profile.theme">Theme</div>
                                        <div class="settings-item-subtitle" data-i18n="profile.themeDesc">Dark / Light mode</div>
                                    </div>
                                </div>
                                <div class="settings-item-value">
                                    <div class="toggle-switch" id="profileThemeToggleSwitch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-header">
                            <i class="fas fa-link"></i>
                            <span data-i18n="profile.openShare">Shared list</span>
                        </div>
                        <div class="settings-list">
                            <div class="settings-item">
                                <div class="settings-item-left" style="flex: 1;">
                                    <div class="settings-item-icon">
                                        <i class="fas fa-share-alt"></i>
                                    </div>
                                    <div class="settings-item-content">
                                        <div class="settings-item-title" data-i18n="profile.openShareTitle">Open shared list</div>
                                        <div class="settings-item-subtitle" data-i18n="profile.openShareDesc">Paste link or share code</div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: var(--space-2); padding: 0 var(--space-4) var(--space-4);">
                                <input type="text" class="chat-input" id="sharedListInput"
                                       data-i18n="profile.openSharePlaceholder"
                                       placeholder="Share link or code"
                                       style="flex: 1; padding: 12px;">
                                <button class="empty-button" onclick="openSharedListManual()" style="padding: var(--space-3) var(--space-4); white-space: nowrap;">
                                    <span data-i18n="action.open">Open</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ Section -->
                    <div class="settings-section">
                        <div class="settings-header">
                            <i class="fas fa-question-circle"></i>
                            <span data-i18n="profile.faq">FAQ</span>
                        </div>
                        <div class="settings-list">
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span class="faq-question-text" data-i18n="faq.whatIs.title">What is Bozorlik AI?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer" data-i18n="faq.whatIs.desc">
                                    Bozorlik AI is your intelligent shopping assistant that helps you create optimized grocery lists, track expenses, and save money on bazaar purchases.
                                </div>
                            </div>

                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span class="faq-question-text" data-i18n="faq.howToUse.title">How to use?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer" data-i18n="faq.howToUse.desc">
                                    Simply type or speak what you need to buy. Our AI will organize your list into categories, suggest prices, and help you track spending. Check analytics to optimize your shopping.
                                </div>
                            </div>

                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span class="faq-question-text" data-i18n="faq.prices.title">How are prices calculated?</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="faq-answer" data-i18n="faq.prices.desc">
                                    We use real market data and averages from local bazaars and supermarkets. Prices are estimates to help you budget effectively.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About Startup -->
                    <div class="settings-section">
                        <div class="settings-header">
                            <i class="fas fa-info-circle"></i>
                            <span data-i18n="profile.about">About</span>
                        </div>
                        <div class="settings-list" style="padding: var(--space-6);">
                            <div style="margin-bottom: var(--space-4);">
                                <div style="font-size: var(--text-lg); font-weight: 700; margin-bottom: var(--space-2); color: var(--primary);">
                                    Bozorlik AI
                                </div>
                                <div style="color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.6; margin-bottom: var(--space-4);">
                                    Making bazaar shopping smarter, faster, and more affordable. Our AI assistant helps thousands of users save time and money every day.
                                </div>
                                <div style="display: flex; gap: var(--space-4); color: var(--text-tertiary); font-size: var(--text-xs);">
                                    <span><i class="fas fa-code-branch"></i> v3.0.0</span>
                                    <span><i class="fas fa-heart" style="color: var(--primary);"></i> Made in Tashkent</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: var(--space-3);">
                                <button class="empty-button" style="flex: 1; padding: var(--space-3);" onclick="window.open('https://t.me/bozorlik_ai', '_blank')">
                                    <i class="fab fa-telegram"></i> Support
                                </button>
                                <button class="empty-button" style="flex: 1; padding: var(--space-3); background: transparent; border: 1.5px solid var(--primary); color: var(--primary); box-shadow: none;" onclick="window.open('https://bozorlik.ai/privacy', '_blank')">
                                    <i class="fas fa-shield-alt"></i> Privacy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-tab="analytics" onclick="switchTab('analytics')">
                <i class="fas fa-chart-line nav-icon"></i>
                <span class="nav-label" data-i18n="nav.analytics">Analytics</span>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" data-tab="chat" onclick="switchTab('chat')">
                <!-- –ò–∫–æ–Ω–∫–∞ Signal Messenger –≤ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                <i class="fa-brands fa-signal-messenger nav-icon" style="color: inherit;"></i>
                <span class="nav-label" data-i18n="nav.chat">Chat</span>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" data-tab="profile" onclick="switchTab('profile')">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label" data-i18n="nav.profile">Profile</span>
                <div class="nav-indicator"></div>
            </div>
        </nav>

        <!-- Language Selection Modal -->
        <div class="modal-backdrop" id="languageModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-globe" style="color: var(--primary);"></i>
                        <span data-i18n="modal.language.title">Choose Language</span>
                    </h3>
                    <button class="modal-close" onclick="closeLanguageModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="language-option active" data-lang="ru" onclick="selectLanguage('ru')">
                        <span class="language-flag">üá∑üá∫</span>
                        <span class="language-name">–†—É—Å—Å–∫–∏–π</span>
                    </div>
                    <div class="language-option" data-lang="uz" onclick="selectLanguage('uz')">
                        <span class="language-flag">üá∫üáø</span>
                        <span class="language-name">O'zbek</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="empty-button" onclick="closeLanguageModal()" style="background: transparent; border: 1.5px solid var(--border-light); color: var(--text-primary); box-shadow: none;">
                        <span data-i18n="modal.cancel">Cancel</span>
                    </button>
                    <button class="empty-button" onclick="applyLanguage()">
                        <span data-i18n="modal.apply">Apply</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- List Detail Modal -->
        <div class="modal-backdrop" id="listDetailModal">
            <div class="modal list-detail-modal">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-shopping-basket" style="color: var(--primary);"></i>
                        <span data-i18n="list.detail">Shopping List</span>
                    </h3>
                    <button class="modal-close" onclick="closeListDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="list-detail-content" id="listDetailContent">
                    <!-- Will be populated by JS -->
                </div>
                <div class="modal-footer">
                    <button class="empty-button" onclick="closeListDetailModal()" style="background: var(--primary-gradient);">
                        <span data-i18n="modal.close">Close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Voice Recording Modal -->
        <div class="modal-backdrop" id="voiceModal">
            <div class="modal" style="max-width: 320px; text-align: center;">
                <div class="modal-content" style="padding: var(--space-8);">
                    <div style="width: 80px; height: 80px; margin: 0 auto var(--space-6); background: var(--primary-gradient); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; animation: pulse 1.5s infinite;">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h3 style="font-size: var(--text-xl); font-weight: 700; margin-bottom: var(--space-3);" data-i18n="voice.recording">Recording...</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-6);" data-i18n="voice.speak">Speak your shopping list</p>
                    <button class="empty-button" onclick="stopVoiceRecording()" style="background: #ef4444; box-shadow: none; width: 100%;">
                        <i class="fas fa-stop"></i>
                        <span data-i18n="voice.stop">Stop Recording</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <script>
        // =============================================
        // BOZORLIK AI 3.0 ¬∑ FULL APPLICATION LOGIC
        // Telegram Mini App ¬∑ Premium Frontend
        // =============================================

        // ---------- CONFIGURATION ----------
        const CONFIG = {
            API_URL: 'http://localhost:8000',
            DEFAULT_USER_ID: Math.floor(Math.random() * 1000000),
            CHART_COLORS: ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ffedd5'],
            MAX_MESSAGES: 50,
            VOICE_TIMEOUT: 60000,
            TOAST_DURATION: 3000
        };

        // ---------- INTERNATIONALIZATION ----------
        const I18N = {
            ru: {
                'nav.analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                'nav.chat': '–ß–∞—Ç',
                'nav.profile': '–ü—Ä–æ—Ñ–∏–ª—å',
                'analytics.title': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                'analytics.loading': '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...',
                'analytics.loadingDesc': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
                'analytics.emptyTitle': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                'analytics.emptyDesc': '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É',
                'analytics.createList': '–°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫',
                'analytics.categoryDistribution': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
                'analytics.aiInsights': 'AI –ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                'analytics.recentActivity': '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏',
                'analytics.totalSpent': '–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ',
                'analytics.totalLists': '—Å–ø–∏—Å–∫–æ–≤',
                'analytics.averageCheck': '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫',
                'analytics.mostFrequent': '–ß–∞—â–µ –≤—Å–µ–≥–æ',
                'analytics.savings': '–≠–∫–æ–Ω–æ–º–∏—è',
                'chat.title': 'Bozorlik AI',
                'chat.welcome': '–ü—Ä–∏–≤–µ—Ç! –Ø Bozorlik AI ‚Äî –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∫—É–ø–æ–∫. –ù–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å!',
                'chat.placeholder': '–ù–∞–ø–∏—à–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫...',
                'chat.typing': 'AI –ø–µ—á–∞—Ç–∞–µ—Ç...',
                'profile.title': '–ü—Ä–æ—Ñ–∏–ª—å',
                'profile.verified': '–ê–∫–∫–∞—É–Ω—Ç Telegram',
                'profile.settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'profile.language': '–Ø–∑—ã–∫',
                'profile.languageDesc': '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
                'profile.theme': '–¢–µ–º–∞',
                'profile.themeDesc': '–¢—ë–º–Ω–∞—è / –°–≤–µ—Ç–ª–∞—è',
                'profile.openShare': '–û–±—â–∏–π —Å–ø–∏—Å–æ–∫',
                'profile.openShareTitle': '–û—Ç–∫—Ä—ã—Ç—å –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫',
                'profile.openShareDesc': '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –∫–æ–¥',
                'profile.openSharePlaceholder': '–°—Å—ã–ª–∫–∞ –∏–ª–∏ –∫–æ–¥',
                'profile.faq': '–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
                'profile.about': '–û –ø—Ä–æ–µ–∫—Ç–µ',
                'faq.whatIs.title': '–ß—Ç–æ —Ç–∞–∫–æ–µ Bozorlik AI?',
                'faq.whatIs.desc': 'Bozorlik AI ‚Äî –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∫—É–ø–æ–∫. –ü–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∏ —ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –±–∞–∑–∞—Ä–µ.',
                'faq.howToUse.title': '–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?',
                'faq.howToUse.desc': '–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å. AI –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –ø–æ–¥—Å–∫–∞–∂–µ—Ç —Ü–µ–Ω—ã –∏ –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç—Ä–∞—Ç—ã.',
                'faq.prices.title': '–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ü–µ–Ω—ã?',
                'faq.prices.desc': '–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã —Å –º–µ—Å—Ç–Ω—ã—Ö —Ä—ã–Ω–∫–æ–≤ –∏ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–æ–≤. –≠—Ç–æ –æ—Ü–µ–Ω–æ—á–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—é–¥–∂–µ—Ç–∞.',
                'modal.language.title': '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',
                'modal.cancel': '–û—Ç–º–µ–Ω–∞',
                'modal.apply': '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                'modal.close': '–ó–∞–∫—Ä—ã—Ç—å',
                'list.detail': '–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫',
                'list.date': '–î–∞—Ç–∞',
                'list.estimated': '–û—Ü–µ–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞',
                'list.final': '–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞',
                'list.items': '—Ç–æ–≤–∞—Ä–æ–≤',
                'list.purchased': '–∫—É–ø–ª–µ–Ω–æ',
                'voice.recording': '–ó–∞–ø–∏—Å—å...',
                'voice.speak': '–ì–æ–≤–æ—Ä–∏—Ç–µ –≤–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫',
                'voice.stop': '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å',
                'toast.saved': '–°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω',
                'toast.error': '–û—à–∏–±–∫–∞',
                'toast.copied': '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞',
                'toast.updated': '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω',
                'toast.expenseSaved': '–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
                'expense.prompt': '–í—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏ –ø–æ–∫—É–ø–∫–∏? –°–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏?',
                'expense.enter': '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',
                'expense.viewAnalytics': '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É',
                'item.add': '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä',
                'item.edit': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                'item.delete': '–£–¥–∞–ª–∏—Ç—å',
                'item.quantity': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                'item.price': '–¶–µ–Ω–∞',
                'item.estimated': '–ü—Ä–∏–º–µ—Ä–Ω–æ',
                'action.save': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                'action.cancel': '–û—Ç–º–µ–Ω–∞',
                'action.share': '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
                'action.open': '–û—Ç–∫—Ä—ã—Ç—å',
                'action.clear': '–û—á–∏—Å—Ç–∏—Ç—å',
                'currency': '—Å—É–º'
            },
            uz: {
                'nav.analytics': 'Tahlil',
                'nav.chat': 'Chat',
                'nav.profile': 'Profil',
                'analytics.title': 'Tahlil',
                'analytics.loading': 'Tahlil yuklanmoqda...',
                'analytics.loadingDesc': 'Iltimos, kuting',
                'analytics.emptyTitle': 'Ma ºlumot yo ªq',
                'analytics.emptyDesc': 'Tahlilni ko ªrish uchun birinchi xaridlar ro ªyxatini yarating',
                'analytics.createList': 'Ro ªyxat yaratish',
                'analytics.categoryDistribution': 'Kategoriyalar bo ªyicha',
                'analytics.aiInsights': 'AI Tahlil',
                'analytics.recentActivity': 'Oxirgi xaridlar',
                'analytics.totalSpent': 'Jami sarflangan',
                'analytics.totalLists': 'ta ro ªyxat',
                'analytics.averageCheck': 'O ªrtacha chek',
                'analytics.mostFrequent': 'Eng ko ªp',
                'analytics.savings': 'Tejamkorlik',
                'chat.title': 'Bozorlik AI',
                'chat.welcome': 'Salom! Men Bozorlik AI ‚Äî xaridlar uchun aqlli yordamchi. Nima xarid qilish kerakligini yozing yoki aytib bering!',
                'chat.placeholder': 'Xaridlar ro ªyxatini yozing...',
                'chat.typing': 'AI yozmoqda...',
                'profile.title': 'Profil',
                'profile.verified': 'Telegram Akkaunt',
                'profile.settings': 'Sozlamalar',
                'profile.language': 'Til',
                'profile.languageDesc': 'Interfeys tilini tanlang',
                'profile.theme': 'Mavzu',
                'profile.themeDesc': 'Qorong ªi / Yorug ª',
                'profile.openShare': "Ulashilgan ro'yxat",
                'profile.openShareTitle': "Ulashilgan ro'yxatni ochish",
                'profile.openShareDesc': "Havola yoki kodni kiriting",
                'profile.openSharePlaceholder': 'Havola yoki kod',
                'profile.faq': 'Ko ªp so ªraladigan savollar',
                'profile.about': 'Loyiha haqida',
                'faq.whatIs.title': 'Bozorlik AI nima?',
                'faq.whatIs.desc': 'Bozorlik AI ‚Äî xaridlar uchun aqlli yordamchi. Optimallashtirilgan ro ªyxatlar yaratish, xarajatlarni kuzatish va bozorda tejashga yordam beradi.',
                'faq.howToUse.title': 'Qanday foydalaniladi?',
                'faq.howToUse.desc': 'Nima xarid qilish kerakligini yozing yoki aytib bering. AI ro ªyxatni kategoriyalarga ajratadi, narxlarni taklif qiladi va xarajatlarni kuzatishga yordam beradi.',
                'faq.prices.title': 'Narxlar qanday hisoblanadi?',
                'faq.prices.desc': 'Biz mahalliy bozor va supermarketlardan olingan real ma ºlumotlar va o ªrtacha narxlardan foydalanamiz. Bu byudjet rejalashtirish uchun taxminiy narxlar.',
                'modal.language.title': 'Tilni tanlang',
                'modal.cancel': 'Bekor qilish',
                'modal.apply': 'Qo ªllash',
                'modal.close': 'Yopish',
                'list.detail': 'Xaridlar ro ªyxati',
                'list.date': 'Sana',
                'list.estimated': 'Taxminiy narx',
                'list.final': 'Haqiqiy summa',
                'list.items': 'tovar',
                'list.purchased': 'sotib olingan',
                'voice.recording': 'Yozilmoqda...',
                'voice.speak': 'Xaridlar ro ªyxatini ayting',
                'voice.stop': 'Yozishni to ªxtatish',
                'toast.saved': 'Ro ªyxat saqlandi',
                'toast.error': 'Xatolik',
                'toast.copied': 'Havola nusxalandi',
                'toast.updated': 'Ro ªyxat yangilandi',
                'toast.expenseSaved': 'Xarajat summasi saqlandi',
                'expense.prompt': 'Xaridlar tugadimi? Qancha sarfladingiz?',
                'expense.enter': 'Summani kiriting',
                'expense.viewAnalytics': 'Tahlilni ko ªrish',
                'item.add': 'Mahsulot qo ªshish',
                'item.edit': 'Tahrirlash',
                'item.delete': 'O ªchirish',
                'item.quantity': 'Miqdor',
                'item.price': 'Narx',
                'item.estimated': 'Taxminan',
                'action.save': 'Saqlash',
                'action.cancel': 'Bekor qilish',
                'action.share': 'Ulashish',
                'action.open': 'Ochish',
                'action.clear': 'Tozalash',
                'currency': "so'm"
            }
        };

        // ---------- GLOBAL STATE ----------
        const State = {
            userId: CONFIG.DEFAULT_USER_ID,
            language: 'ru',
            theme: 'light',
            currentTab: 'analytics',
            shoppingList: null,
            currentListId: null,
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            websocket: null,
            telegramUser: null,
            analytics: null,
            chart: null,
            messages: [],
            editingItem: null,
            pendingLanguage: 'ru',
            showExpensePrompt: false,
            currentListDetail: null
        };

        // ---------- TELEGRAM WEBAPP INIT ----------
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.enableClosingConfirmation();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#ffffff');

            // Get Telegram user data
            if (tg.initDataUnsafe?.user) {
                State.telegramUser = tg.initDataUnsafe.user;
                State.userId = State.telegramUser.id;
            }

            // Apply Telegram theme
            if (tg.colorScheme === 'dark') {
                State.theme = 'dark';
                document.body.classList.add('dark');
            }
        }

        // ---------- INITIALIZATION ----------
        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
        });

        async function initApp() {
            // Load saved preferences
            loadPreferences();

            // Initialize UI
            updateUITexts();
            setupEventListeners();

            // Connect WebSocket
            connectWebSocket();

            // Load initial data
            await loadAnalytics();

            // Add welcome message
            addWelcomeMessage();

            // Update profile with Telegram data
            updateProfileInfo();

            // Handle share deep-link start param
            await handleShareStartParam();

            // Hide loading states
            document.getElementById('app').style.display = 'block';
        }

        async function handleShareStartParam() {
            const startParam = tg?.initDataUnsafe?.start_param;
            if (!startParam || !startParam.startsWith('share_')) {
                return;
            }

            const parts = startParam.split('_', 3);
            if (parts.length !== 3) {
                return;
            }

            const payload = parts[2]?.trim();
            if (!payload) {
                return;
            }

            await loadSharedList(payload);
            switchTab('chat');
        }

        function loadPreferences() {
            // Load language
            const savedLang = localStorage.getItem('bozorlik_language');
            if (savedLang && I18N[savedLang]) {
                State.language = savedLang;
                State.pendingLanguage = savedLang;
            }

            // Load theme
            const savedTheme = localStorage.getItem('bozorlik_theme');
            if (savedTheme === 'dark' || (tg?.colorScheme === 'dark' && !savedTheme)) {
                State.theme = 'dark';
                document.body.classList.add('dark');
                updateThemeIcons('dark');
            } else {
                State.theme = 'light';
                document.body.classList.remove('dark');
                updateThemeIcons('light');
            }

            // Load user ID
            const savedUserId = localStorage.getItem('bozorlik_user_id');
            if (savedUserId) {
                State.userId = parseInt(savedUserId);
            } else {
                localStorage.setItem('bozorlik_user_id', State.userId);
            }
        }

        function setupEventListeners() {
            // Theme toggles
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('chatThemeToggle').addEventListener('click', toggleTheme);
            document.getElementById('profileThemeToggle').addEventListener('click', toggleTheme);
            document.getElementById('profileThemeToggleSwitch').addEventListener('click', toggleTheme);

            // Chat input
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('clearChatInput').addEventListener('click', () => {
                document.getElementById('chatInput').value = '';
            });

            // Voice button
            document.getElementById('voiceButton').addEventListener('click', toggleVoiceRecording);

            // Global click handler for closing modals
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop')) {
                    closeAllModals();
                }
            });

            // Escape key
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                    cancelEditing();
                }
            });
        }

        // ---------- TAB MANAGEMENT ----------
        window.switchTab = function(tabId) {
            State.currentTab = tabId;

            // Update navigation items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabId);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('active', tab.id === `${tabId}Tab`);
            });

            // Refresh data if needed
            if (tabId === 'analytics') {
                loadAnalytics();
            }
        };

        window.switchToChat = function() {
            switchTab('chat');
        };

        // ---------- THEME MANAGEMENT ----------
        function toggleTheme() {
            State.theme = State.theme === 'light' ? 'dark' : 'light';

            if (State.theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }

            updateThemeIcons(State.theme);
            localStorage.setItem('bozorlik_theme', State.theme);

            // Update Telegram theme if available
            if (tg) {
                tg.setHeaderColor(State.theme === 'dark' ? '#000000' : '#ffffff');
                tg.setBackgroundColor(State.theme === 'dark' ? '#000000' : '#ffffff');
            }

            // Refresh chart with new theme
            if (State.analytics && State.currentTab === 'analytics') {
                renderCategoryChart(State.analytics.category_breakdown);
            }

            showToast(State.language === 'ru' ? '–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞' : 'Mavzu o\'zgartirildi');
        }

        function updateThemeIcons(theme) {
            const iconElements = [
                document.querySelector('#themeToggle i'),
                document.querySelector('#chatThemeToggle i'),
                document.querySelector('#profileThemeToggle i')
            ];

            iconElements.forEach(el => {
                if (el) {
                    el.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
            });

            const toggleSwitch = document.querySelector('#profileThemeToggleSwitch');
            if (toggleSwitch) {
                toggleSwitch.classList.toggle('active', theme === 'dark');
            }
        }

        // ---------- LANGUAGE MANAGEMENT ----------
        window.openLanguageModal = function() {
            State.pendingLanguage = State.language;

            // Update active state in modal
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.lang === State.language);
            });

            document.getElementById('languageModal').classList.add('active');
        };

        window.closeLanguageModal = function() {
            document.getElementById('languageModal').classList.remove('active');
        };

        window.selectLanguage = function(lang) {
            State.pendingLanguage = lang;

            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.lang === lang);
            });
        };

        window.applyLanguage = function() {
            setLanguage(State.pendingLanguage);
            closeLanguageModal();
        };

        function setLanguage(lang) {
            State.language = lang;
            localStorage.setItem('bozorlik_language', lang);

            updateUITexts();
            setServerLanguage(lang);

            // Update current language display
            const currentLangEl = document.getElementById('currentLanguage');
            if (currentLangEl) {
                currentLangEl.textContent = lang === 'ru' ? '–†—É—Å—Å–∫–∏–π' : "O'zbek";
            }

            // Update welcome message if no messages
            if (State.messages.length === 0) {
                addWelcomeMessage();
            }

            showToast(lang === 'ru' ? '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω' : 'Til o\'zgartirildi');
        }

        function updateUITexts() {
            const lang = State.language;
            const texts = I18N[lang];

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (texts[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = texts[key];
                    } else {
                        el.textContent = texts[key];
                    }
                }
            });

            // Update chat input placeholder
            document.getElementById('chatInput').placeholder = texts['chat.placeholder'];

            // Update insights time
            const insightsTime = document.getElementById('insightsTime');
            if (insightsTime) {
                insightsTime.textContent = lang === 'ru' ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–π—á–∞—Å' : 'Hozir yangilandi';
            }
        }

        async function setServerLanguage(lang) {
            try {
                const formData = new FormData();
                formData.append('user_id', State.userId);
                formData.append('language', lang);

                await fetch(`${CONFIG.API_URL}/api/set-language`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Set language error:', error);
            }
        }

        // ---------- PROFILE MANAGEMENT ----------
        function updateProfileInfo() {
            if (State.telegramUser) {
                const name = [State.telegramUser.first_name, State.telegramUser.last_name].filter(Boolean).join(' ');
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileId').textContent = `@${State.telegramUser.username || State.telegramUser.id}`;

                // Set avatar initials
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('avatarInitials').textContent = initials || 'BZ';
            } else {
                document.getElementById('profileName').textContent = 'Telegram User';
                document.getElementById('profileId').textContent = `ID: ${State.userId}`;
                document.getElementById('avatarInitials').textContent = 'TG';
            }
        }

        // ---------- ANALYTICS ----------
        async function loadAnalytics() {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/analytics/${State.userId}`);
                const data = await response.json();

                if (data.success) {
                    State.analytics = data.data;
                    renderAnalytics();
                }
            } catch (error) {
                console.error('Load analytics error:', error);
            }
        }

        function renderAnalytics() {
            const analyticsEl = document.getElementById('analyticsData');
            const loadingEl = document.getElementById('analyticsLoading');
            const emptyEl = document.getElementById('analyticsEmpty');

            if (!State.analytics || State.analytics.total_lists === 0) {
                analyticsEl.style.display = 'none';
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'flex';
                return;
            }

            loadingEl.style.display = 'none';
            emptyEl.style.display = 'none';
            analyticsEl.style.display = 'block';

            renderStats();
            renderCategoryChart(State.analytics.category_breakdown);
            renderInsights();
            renderRecentActivity();
        }

        function renderStats() {
            const lang = State.language;
            const texts = I18N[lang];
            const a = State.analytics;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-value">${formatPrice(a.total_spent)}</div>
                    <div class="stat-label">${texts['analytics.totalSpent']}</div>
                    <div class="stat-trend">
                        <i class="fas fa-shopping-basket"></i> ${a.total_lists} ${texts['analytics.totalLists']}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-value">${formatPrice(a.average_spent)}</div>
                    <div class="stat-label">${texts['analytics.averageCheck']}</div>
                    <div class="stat-trend">
                        <i class="fas fa-calendar"></i> ${lang === 'ru' ? '–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è' : 'Barcha vaqt'}
                    </div>
                </div>
            `;
        }

        function renderCategoryChart(categoryData) {
            const ctx = document.getElementById('spendingChart').getContext('2d');

            if (State.chart) {
                State.chart.destroy();
            }

            if (!categoryData || Object.keys(categoryData).length === 0) {
                document.getElementById('chartLegend').innerHTML = '<span style="color: var(--text-tertiary)">No data</span>';
                return;
            }

            const categories = Object.keys(categoryData);
            const values = Object.values(categoryData);

            State.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: values,
                        backgroundColor: CONFIG.CHART_COLORS,
                        borderWidth: 0,
                        borderRadius: 8,
                        spacing: 4
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'var(--surface-elevated)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border-light)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 12
                        }
                    },
                    maintainAspectRatio: false
                }
            });

            // Update legend
            const legendEl = document.getElementById('chartLegend');
            legendEl.innerHTML = categories.map((cat, i) => `
                <span style="display: inline-flex; align-items: center; gap: 6px; margin-right: 12px;">
                    <span style="width: 10px; height: 10px; border-radius: 3px; background: ${CONFIG.CHART_COLORS[i % CONFIG.CHART_COLORS.length]}"></span>
                    <span style="font-size: 12px; color: var(--text-secondary);">${cat}</span>
                </span>
            `).join('');
        }

        function renderInsights() {
            const lang = State.language;
            const a = State.analytics;
            const insightsEl = document.getElementById('insightsText');

            if (a.total_lists === 0) {
                insightsEl.textContent = lang === 'ru'
                    ? '–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É!'
                    : 'Sizda hali xaridlar yo ªq. Tahlilni ko ªrish uchun birinchi ro ªyxatni yarating!';
                return;
            }

            // Generate AI insight
            let insight = '';
            if (a.total_spent > 0) {
                if (a.min_spent && a.max_spent) {
                    insight = lang === 'ru'
                        ? `‚ú® –í–∞—à —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${formatPrice(a.average_spent)}. –°–∞–º—ã–π –±—é–¥–∂–µ—Ç–Ω—ã–π –ø–æ—Ö–æ–¥ –Ω–∞ –±–∞–∑–∞—Ä ‚Äî ${formatPrice(a.min_spent)}, —Å–∞–º—ã–π –∫—Ä—É–ø–Ω—ã–π ‚Äî ${formatPrice(a.max_spent)}.`
                        : `‚ú® O ªrtacha chekingiz ${formatPrice(a.average_spent)}. Eng arzon bozor ‚Äî ${formatPrice(a.min_spent)}, eng qimmati ‚Äî ${formatPrice(a.max_spent)}.`;
                }
            }

            if (a.category_breakdown) {
                const topCategory = Object.entries(a.category_breakdown)
                    .sort((a, b) => b[1] - a[1])[0];

                if (topCategory) {
                    insight += lang === 'ru'
                        ? ` –ß–∞—â–µ –≤—Å–µ–≥–æ –≤—ã –ø–æ–∫—É–ø–∞–µ—Ç–µ ${topCategory[0].toLowerCase()} (${topCategory[1]} —Ä–∞–∑).`
                        : ` Ko ªpincha siz ${topCategory[0].toLowerCase()} (${topCategory[1]} marta) xarid qilasiz.`;
                }
            }

            insightsEl.textContent = insight || (lang === 'ru'
                ? '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Bozorlik AI –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤!'
                : 'Bozorlik AI dan foydalanishni davom eting va xarajatlaringizni optimallashtiring!');
        }

        function renderRecentActivity() {
            const lang = State.language;
            const history = State.analytics?.history || [];
            const recentEl = document.getElementById('recentActivityList');

            if (history.length === 0) {
                recentEl.innerHTML = `
                    <div style="padding: var(--space-6); text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-history" style="font-size: 24px; margin-bottom: var(--space-3); opacity: 0.5;"></i>
                        <p>${lang === 'ru' ? '–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫' : 'Xaridlar tarixi yo ªq'}</p>
                    </div>
                `;
                return;
            }

            recentEl.innerHTML = history.slice(0, 20).map(item => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'uz-UZ', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                return `
                    <div class="settings-item" onclick="viewShoppingListDetails('${item.list_id}')">
                        <div class="settings-item-left">
                            <div class="settings-item-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="settings-item-content">
                                <div class="settings-item-title">${formattedDate}</div>
                                <div class="settings-item-subtitle">
                                    ${item.items_count} ${lang === 'ru' ? '—Ç–æ–≤–∞—Ä–æ–≤' : 'tovarlar'}
                                    ${item.purchased_items ? ` ¬∑ ${item.purchased_items} ${lang === 'ru' ? '–∫—É–ø–ª–µ–Ω–æ' : 'sotib olingan'}` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="settings-item-value" style="color: var(--primary); font-weight: 600;">
                            ${item.final_amount ? formatPrice(item.final_amount) : formatPrice(item.estimated_price)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ---------- LIST DETAIL MODAL ----------
        window.viewShoppingListDetails = async function(listId) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/analytics/${State.userId}/list/${listId}`);
                const data = await response.json();

                if (data.success) {
                    State.currentListDetail = data.data;
                    renderListDetailModal(data.data);
                    document.getElementById('listDetailModal').classList.add('active');
                }
            } catch (error) {
                console.error('View list details error:', error);
            }
        };

        function renderListDetailModal(listData) {
            const lang = State.language;
            const texts = I18N[lang];
            const content = document.getElementById('listDetailContent');

            const date = new Date(listData.date);
            const formattedDate = date.toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'uz-UZ', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let html = `
                <div class="list-detail-header">
                    <div>
                        <div class="list-detail-date">${formattedDate}</div>
                        <div style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-1);">
                            ${listData.items_count} ${texts['list.items']} ¬∑
                            ${listData.purchased_items || 0} ${texts['list.purchased']}
                        </div>
                    </div>
                    <div class="list-detail-total">
                        ${listData.final_amount ? formatPrice(listData.final_amount) : formatPrice(listData.estimated_price)}
                    </div>
                </div>
            `;

            // Display full text if available
            if (listData.full_text) {
                html += `
                    <div style="background: var(--surface-tertiary); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-4);">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                            <i class="fas fa-robot" style="color: var(--primary);"></i>
                            <span style="font-weight: 600;">Bozorlik AI</span>
                        </div>
                        <div style="white-space: pre-wrap; font-size: var(--text-sm); color: var(--text-secondary);">
                            ${listData.full_text.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            }

            // Display items by category
            if (listData.categories && Object.keys(listData.categories).length > 0) {
                html += `<div style="margin-top: var(--space-4);">`;

                Object.entries(listData.categories).forEach(([category, items]) => {
                    if (items && items.length > 0) {
                        const categoryTotal = items.reduce((sum, item) => sum + (item.estimated_price || 0), 0);

                        html += `
                            <div style="margin-bottom: var(--space-4);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); font-weight: 600;">
                                        ${getCategoryIcon(category)}
                                        <span>${category}</span>
                                    </div>
                                    <div style="font-size: var(--text-sm); color: var(--primary);">
                                        ${formatPrice(categoryTotal)}
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                        `;

                        items.forEach(item => {
                            html += `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-2) var(--space-3); background: var(--surface-primary); border-radius: var(--radius-lg);">
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <div style="width: 20px; height: 20px; border-radius: var(--radius-sm); border: 2px solid ${item.purchased ? 'var(--primary)' : 'var(--border-medium)'}; background: ${item.purchased ? 'var(--primary)' : 'transparent'}; display: flex; align-items: center; justify-content: center;">
                                            ${item.purchased ? '<span style="color: white; font-size: 12px;">‚úì</span>' : ''}
                                        </div>
                                        <span style="${item.purchased ? 'text-decoration: line-through; color: var(--text-tertiary);' : ''}">
                                            ${item.name}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <span style="font-size: var(--text-xs); color: var(--text-tertiary);">${item.quantity || ''}</span>
                                        ${item.estimated_price ? `<span style="font-weight: 600; color: var(--primary);">${formatPrice(item.estimated_price)}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        });

                        html += `</div></div>`;
                    }
                });

                html += `</div>`;
            }

            // Summary
            html += `
                <div style="margin-top: var(--space-6); padding: var(--space-4); background: var(--surface-tertiary); border-radius: var(--radius-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">${texts['list.estimated']}:</span>
                        <span style="font-weight: 600;">${formatPrice(listData.estimated_price || 0)}</span>
                    </div>
                    ${listData.final_amount ? `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-2);">
                            <span style="color: var(--text-secondary);">${texts['list.final']}:</span>
                            <span style="font-weight: 700; color: var(--primary);">${formatPrice(listData.final_amount)}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            content.innerHTML = html;
        }

        window.closeListDetailModal = function() {
            document.getElementById('listDetailModal').classList.remove('active');
            State.currentListDetail = null;
        };

        // ---------- CHAT ----------
        function addWelcomeMessage() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${I18N[State.language]['chat.welcome']}
                </div>
                <div class="message-time">
                    <i class="far fa-clock"></i>
                    ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            State.messages = [{ role: 'ai', content: I18N[State.language]['chat.welcome'] }];

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
        }

        function addMessage(content, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

            messageDiv.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">
                    <i class="far fa-clock"></i>
                    ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;

            chatMessages.appendChild(messageDiv);

            // –í–ê–ñ–ù–û: –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã DOM –æ–±–Ω–æ–≤–∏–ª—Å—è
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);

            State.messages.push({ role: isUser ? 'user' : 'ai', content });

            // Keep only last 50 messages
            if (State.messages.length > CONFIG.MAX_MESSAGES) {
                State.messages = State.messages.slice(-CONFIG.MAX_MESSAGES);
            }

            return messageDiv;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);

            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text) return;

            // Add user message
            addMessage(text, true);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.userId,
                        text: text,
                        language: State.language,
                        is_voice: false,
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();
                hideTypingIndicator();

                if (data.success) {
                    if (data.type === 'shopping_list') {
                        State.shoppingList = data.data;
                        State.currentListId = data.data.list_id;

                        const formattedList = formatShoppingList(data.data);
                        addMessage(formattedList, false);
                    } else {
                        addMessage(data.message, false);
                    }
                } else {
                    addMessage(`‚ùå ${data.error || 'Error'}`, false);
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('Send message error:', error);
                addMessage('‚ùå Connection error', false);
            }
        }

        function formatShoppingList(listData) {
            const lang = State.language;
            const texts = I18N[lang];

            let html = `<div class="shopping-list">`;

            if (listData.categories) {
                Object.entries(listData.categories).forEach(([category, items]) => {
                    if (items && items.length > 0) {
                        const categoryTotal = items.reduce((sum, item) => sum + (item.estimated_price || 0), 0);

                        html += `
                            <div class="list-category">
                                <div class="category-header">
                                    <div class="category-title">
                                        ${getCategoryIcon(category)}
                                        <span>${category}</span>
                                    </div>
                                    <div class="category-total">${formatPrice(categoryTotal)}</div>
                                </div>
                                <div class="list-items">
                        `;

                        items.forEach(item => {
                            html += `
                                <div class="list-item ${item.purchased ? 'purchased' : ''}"
                                     onclick="togglePurchase('${category.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}')">
                                    <div class="item-checkbox ${item.purchased ? 'checked' : ''}"></div>
                                    <div class="item-content">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-details">
                                            <span class="item-quantity">${item.quantity || ''}</span>
                                            ${item.estimated_price ? `
                                                <span class="item-price">${formatPrice(item.estimated_price)}</span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="item-actions" onclick="event.stopPropagation()">
                                        <button class="item-action-btn" onclick="startEditingItem('${category.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}', '${(item.quantity || '').replace(/'/g, "\\'")}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="item-action-btn" onclick="deleteItemFromList('${category.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });

                        html += `</div></div>`;
                    }
                });
            }

            // Summary
            html += `
                <div style="margin-top: var(--space-4); padding: var(--space-4); background: var(--surface-primary); border-radius: var(--radius-lg);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                        <span style="color: var(--text-secondary);">${texts['analytics.totalSpent']}:</span>
                        <span style="font-weight: 700; color: var(--primary);">${formatPrice(listData.total_estimated_price || 0)}</span>
                    </div>
                    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4);">
                        <button class="empty-button" style="flex: 1; padding: var(--space-3);" onclick="shareShoppingList()">
                            <i class="fas fa-share-alt"></i> ${texts['action.share']}
                        </button>
                        <button class="empty-button" style="flex: 1; padding: var(--space-3); background: transparent; border: 1.5px solid var(--border-light); color: var(--text-primary); box-shadow: none;" onclick="clearShoppingList()">
                            <i class="fas fa-trash"></i> ${texts['action.clear']}
                        </button>
                    </div>
                </div>
            </div>`;

            return html;
        }

        function getCategoryIcon(category) {
            if (category.includes('ü•ï')) return 'ü•ï';
            if (category.includes('üçé')) return 'üçé';
            if (category.includes('ü•õ')) return 'ü•õ';
            if (category.includes('üçñ')) return 'üçñ';
            if (category.includes('üì¶')) return 'üì¶';
            if (category.includes('ü•§')) return 'ü•§';
            if (category.includes('üß¥')) return 'üß¥';
            return 'üìù';
        }

        function formatPrice(price) {
            if (!price && price !== 0) return '';
            // Round to integer and format with spaces
            const roundedPrice = Math.round(price);
            return roundedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ` ${I18N[State.language].currency}`;
        }

        // ---------- SHOPPING LIST ACTIONS ----------
        window.togglePurchase = async function(category, itemName) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/list/${State.userId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category,
                        item_name: itemName,
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    State.shoppingList = data.data;
                    refreshShoppingListMessage();

                    // Check if all items are purchased or no items remain
                    if (data.all_purchased || data.remaining_items === 0) {
                        State.showExpensePrompt = true;
                        showExpensePrompt();
                    }
                }
            } catch (error) {
                console.error('Toggle purchase error:', error);
            }
        };

        window.startEditingItem = function(category, itemName, quantity) {
            cancelEditing();

            State.editingItem = { category, itemName, quantity };

            const items = document.querySelectorAll('.list-item');
            let itemElement = null;

            for (let item of items) {
                const nameEl = item.querySelector('.item-name');
                if (nameEl && nameEl.textContent.trim() === itemName) {
                    itemElement = item;
                    break;
                }
            }

            if (itemElement) {
                itemElement.classList.add('editing');

                const contentEl = itemElement.querySelector('.item-content');
                const originalHTML = contentEl.innerHTML;

                contentEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                        <input type="text" class="chat-input" id="editNameInput"
                               value="${itemName}" placeholder="${I18N[State.language]['item.add']}"
                               style="padding: 12px; border-radius: var(--radius-lg);">
                        <input type="text" class="chat-input" id="editQuantityInput"
                               value="${quantity}" placeholder="${I18N[State.language]['item.quantity']}"
                               style="padding: 12px; border-radius: var(--radius-lg);">
                        <div style="display: flex; gap: var(--space-2);">
                            <button class="empty-button" style="flex: 1; padding: 12px;" onclick="saveEditedItem()">
                                <i class="fas fa-check"></i> ${I18N[State.language]['action.save']}
                            </button>
                            <button class="empty-button" style="flex: 1; padding: 12px; background: transparent; border: 1.5px solid var(--border-light); color: var(--text-primary);" onclick="cancelEditing()">
                                <i class="fas fa-times"></i> ${I18N[State.language]['action.cancel']}
                            </button>
                        </div>
                    </div>
                `;

                itemElement.dataset.originalContent = originalHTML;
                setTimeout(() => document.getElementById('editNameInput')?.focus(), 50);
            }
        };

        window.saveEditedItem = async function() {
            if (!State.editingItem) return;

            const newName = document.getElementById('editNameInput')?.value.trim();
            const newQuantity = document.getElementById('editQuantityInput')?.value.trim();

            if (!newName) return;

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/list/${State.userId}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.userId,
                        text: State.language === 'ru'
                            ? `–ó–∞–º–µ–Ω–∏ ${State.editingItem.itemName} –Ω–∞ ${newName} ${newQuantity}`
                            : `${State.editingItem.itemName} ni ${newName} ${newQuantity} ga almashtir`,
                        language: State.language,
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    State.shoppingList = data.data;
                    refreshShoppingListMessage();
                    showToast(I18N[State.language]['toast.updated']);
                    cancelEditing();
                }
            } catch (error) {
                console.error('Edit error:', error);
            }
        };

        window.cancelEditing = function() {
            document.querySelectorAll('.list-item.editing').forEach(item => {
                if (item.dataset.originalContent) {
                    item.querySelector('.item-content').innerHTML = item.dataset.originalContent;
                }
                item.classList.remove('editing');
                delete item.dataset.originalContent;
            });
            State.editingItem = null;
        };

        window.deleteItemFromList = async function(category, itemName) {
            if (!confirm(State.language === 'ru'
                ? `–£–¥–∞–ª–∏—Ç—å "${itemName}" –∏–∑ —Å–ø–∏—Å–∫–∞?`
                : `"${itemName}" ni ro'yxatdan o'chirish?`)) {
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/list/${State.userId}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.userId,
                        text: State.language === 'ru' ? `–£–¥–∞–ª–∏ ${itemName}` : `${itemName} ni o'chir`,
                        language: State.language,
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    State.shoppingList = data.data;
                    refreshShoppingListMessage();

                    // Check if no items remain
                    if (data.data.total_items === 0 || data.data.remaining_items === 0) {
                        State.showExpensePrompt = true;
                        showExpensePrompt();
                    }

                    showToast(State.language === 'ru' ? '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω' : "Tovar o'chirildi");
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        };

        function refreshShoppingListMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const messages = chatMessages.querySelectorAll('.message');

            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.querySelector('.shopping-list')) {
                    lastMessage.remove();
                }
            }

            if (State.shoppingList) {
                addMessage(formatShoppingList(State.shoppingList), false);
            }
        }

        async function loadSharedList(payload) {
            if (!payload) return;

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/shared/${payload}?viewer_id=${State.userId}`);
                const data = await response.json();

                if (data.success && data.data && data.data.list_data) {
                    State.shoppingList = data.data.list_data;
                    State.currentListId = data.data.list_data.list_id;
                    addMessage(formatShoppingList(data.data.list_data), false);
                } else {
                    showToast(I18N[State.language]['toast.error'] || 'Share not found', 'error');
                }
            } catch (error) {
                console.error('Load shared list error:', error);
                showToast(I18N[State.language]['toast.error'] || 'Share error', 'error');
            }
        }

        async function shareShoppingList() {
            if (!State.shoppingList) {
                showToast(I18N[State.language]['noListError'] || 'No list to share', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.userId,
                        list_id: State.currentListId || 'new',
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const payload = data.payload || data.list_id;
                    if (!payload) {
                        showToast(I18N[State.language]['toast.error'] || 'Share error', 'error');
                        return;
                    }

                    const deepLink = `https://t.me/BozorlikAI_bot?start=share_${State.userId}_${payload}`;

                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(deepLink);
                        }
                    } catch (error) {
                        console.warn('Clipboard copy failed', error);
                    }

                    if (tg && typeof tg.openTelegramLink === 'function') {
                        tg.openTelegramLink(deepLink);
                    } else {
                        window.open(deepLink, '_blank', 'noopener,noreferrer');
                    }

                    showToast(I18N[State.language]['toast.copied']);
                }
            } catch (error) {
                console.error('Share error:', error);
            }
        }

        window.clearShoppingList = async function() {
            if (!State.shoppingList) return;

            if (!confirm(State.language === 'ru'
                ? '–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫?'
                : "Ro'yxatni tozalash?")) {
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_URL}/api/list/${State.userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    State.shoppingList = null;
                    State.currentListId = null;
                    State.showExpensePrompt = false;

                    const chatMessages = document.getElementById('chatMessages');
                    const messages = chatMessages.querySelectorAll('.message');
                    if (messages.length > 0 && messages[messages.length - 1].querySelector('.shopping-list')) {
                        messages[messages.length - 1].remove();
                    }

                    showToast(I18N[State.language]['toast.saved']);
                }
            } catch (error) {
                console.error('Clear list error:', error);
            }
        };

        function showExpensePrompt() {
            // Check if prompt already shown
            if (!State.showExpensePrompt) return;

            const lang = State.language;
            const texts = I18N[lang];

            // Create expense prompt message
            const chatMessages = document.getElementById('chatMessages');

            const promptDiv = document.createElement('div');
            promptDiv.className = 'message ai';
            promptDiv.id = 'expensePrompt';

            promptDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="expense-prompt">
                        <div class="expense-title">
                            <i class="fas fa-receipt"></i>
                            ${texts['expense.prompt']}
                        </div>
                        <div style="display: flex; gap: var(--space-3); margin-top: var(--space-3);">
                            <input type="text" class="chat-input" id="expenseAmountInput"
                                   placeholder="${texts['expense.enter']}"
                                   style="flex: 1; padding: 12px; border-radius: var(--radius-lg);">
                        </div>
                        <div class="expense-buttons">
                            <button class="analytics-button" onclick="submitExpense()" style="flex: 1;">
                                <i class="fas fa-check"></i>
                                ${texts['action.save']}
                            </button>
                            <button class="analytics-button" onclick="viewAnalyticsFromExpense()" style="flex: 1; background: transparent; border: 1.5px solid white; color: white; box-shadow: none;">
                                <i class="fas fa-chart-line"></i>
                                ${texts['expense.viewAnalytics']}
                            </button>
                            <button class="analytics-button" onclick="cancelExpensePrompt()" style="flex: 1; background: rgba(255,255,255,0.2); border: 1.5px solid transparent; box-shadow: none;">
                                <i class="fas fa-times"></i>
                                ${texts['action.cancel']}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="message-time">
                    <i class="far fa-clock"></i>
                    ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;

            chatMessages.appendChild(promptDiv);

            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);

            setTimeout(() => document.getElementById('expenseAmountInput')?.focus(), 100);
        }

        window.submitExpense = async function() {
            const amountInput = document.getElementById('expenseAmountInput');
            if (!amountInput) return;

            const amountText = amountInput.value.trim();
            if (!amountText) return;

            const amount = parseAmount(amountText);
            if (amount > 0) {
                await addExpense(amount);
            }

            // Remove prompt
            const prompt = document.getElementById('expensePrompt');
            if (prompt) prompt.remove();

            State.showExpensePrompt = false;
        };

        window.viewAnalyticsFromExpense = function() {
            // Save expense first
            const amountInput = document.getElementById('expenseAmountInput');
            if (amountInput && amountInput.value.trim()) {
                const amount = parseAmount(amountInput.value.trim());
                if (amount > 0) {
                    addExpense(amount, true); // true = don't switch tab
                }
            }

            // Remove prompt
            const prompt = document.getElementById('expensePrompt');
            if (prompt) prompt.remove();

            // Switch to analytics tab
            switchTab('analytics');
            State.showExpensePrompt = false;
        };

        window.cancelExpensePrompt = function() {
            const prompt = document.getElementById('expensePrompt');
            if (prompt) prompt.remove();
            State.showExpensePrompt = false;
        };

        async function addExpense(amount, keepInChat = false) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/expense`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.userId,
                        amount: amount,
                        currency: 'UZS',
                        list_id: State.currentListId,
                        telegram_user: State.telegramUser || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (!keepInChat) {
                        addMessage(I18N[State.language]['toast.expenseSaved'], false);
                    }
                    showToast(I18N[State.language]['toast.expenseSaved']);

                    // Clear current shopping list
                    State.shoppingList = null;
                    State.currentListId = null;

                    // Refresh analytics
                    loadAnalytics();
                }
            } catch (error) {
                console.error('Add expense error:', error);
            }
        }

        function parseAmount(text) {
            let cleanText = text.toLowerCase().replace(/\s+/g, '');

            if (cleanText.includes('–∫–∫')) {
                return parseFloat(cleanText.replace('–∫–∫', '')) * 1000000 || 0;
            }
            if (cleanText.includes('–∫')) {
                return parseFloat(cleanText.replace('–∫', '')) * 1000 || 0;
            }
            if (cleanText.includes('million') || cleanText.includes('–º–∏–ª–ª–∏–æ–Ω')) {
                return parseFloat(cleanText.replace(/[^\d.]/g, '')) * 1000000 || 0;
            }
            if (cleanText.includes('ming') || cleanText.includes('—Ç—ã—Å—è—á')) {
                return parseFloat(cleanText.replace(/[^\d.]/g, '')) * 1000 || 0;
            }

            const num = parseFloat(cleanText.replace(/[^\d.]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        // ---------- VOICE RECORDING ----------
        function toggleVoiceRecording() {
            if (State.isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        async function startVoiceRecording() {
            if (!navigator.mediaDevices?.getUserMedia) {
                showToast(I18N[State.language]['micError'] || 'Microphone not available', 'error');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });

                State.mediaRecorder = new MediaRecorder(stream);
                State.audioChunks = [];

                State.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        State.audioChunks.push(e.data);
                    }
                };

                State.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(State.audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);

                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById('voiceModal').classList.remove('active');
                    document.getElementById('voiceButton').classList.remove('recording');
                    State.isRecording = false;
                };

                State.mediaRecorder.start();
                State.isRecording = true;

                document.getElementById('voiceButton').classList.add('recording');
                document.getElementById('voiceModal').classList.add('active');

                setTimeout(() => {
                    if (State.isRecording) {
                        stopVoiceRecording();
                    }
                }, CONFIG.VOICE_TIMEOUT);

            } catch (error) {
                console.error('Voice recording error:', error);
                showToast(I18N[State.language]['micError'] || 'Microphone error', 'error');
            }
        }

        window.stopVoiceRecording = function() {
            if (State.mediaRecorder && State.isRecording) {
                State.mediaRecorder.stop();
            }
        };

        async function sendVoiceMessage(audioBlob) {
            showTypingIndicator();

            try {
                const formData = new FormData();
                formData.append('user_id', State.userId);
                formData.append('language', State.language);
                formData.append('voice_file', audioBlob, 'voice.webm');
                if (State.telegramUser) {
                    formData.append('telegram_user', JSON.stringify(State.telegramUser));
                }

                const response = await fetch(`${CONFIG.API_URL}/api/voice`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hideTypingIndicator();

                if (data.success) {
                    addMessage('üé§ ' + (data.transcribed_text || 'Voice message'), true);

                    if (data.type === 'shopping_list') {
                        State.shoppingList = data.data;
                        State.currentListId = data.data.list_id;
                        addMessage(formatShoppingList(data.data), false);
                    } else {
                        addMessage(data.message, false);
                    }
                } else {
                    addMessage('‚ùå ' + (data.error || 'Voice processing error'), false);
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('Voice send error:', error);
                addMessage('‚ùå Connection error', false);
            }
        }

        // ---------- WEBSOCKET ----------
        function connectWebSocket() {
            try {
                const wsUrl = CONFIG.API_URL.replace('http', 'ws') + `/ws/${State.userId}`;
                State.websocket = new WebSocket(wsUrl);

                State.websocket.onopen = () => {
                    console.log('WebSocket connected');
                };

                State.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket parse error:', error);
                    }
                };

                State.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                State.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    setTimeout(connectWebSocket, 5000);
                };
            } catch (error) {
                console.error('WebSocket connection error:', error);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'shopping_list':
                    State.shoppingList = data.data;
                    State.currentListId = data.data.list_id;
                    refreshShoppingListMessage();
                    break;
                case 'list_updated':
                    State.shoppingList = data.data;
                    refreshShoppingListMessage();

                    if (data.all_purchased || data.remaining_items === 0) {
                        State.showExpensePrompt = true;
                        showExpensePrompt();
                    }
                    break;
                case 'error':
                    showToast(data.message, 'error');
                    break;
            }
        }

        // ---------- TOAST ----------
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('i');

            toastMessage.textContent = message;

            if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
                toastIcon.style.color = '#ef4444';
            } else {
                toastIcon.className = 'fas fa-check-circle';
                toastIcon.style.color = 'var(--primary)';
            }

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, CONFIG.TOAST_DURATION);
        }

        // ---------- FAQ ----------
        window.toggleFaq = function(element) {
            const faqItem = element.closest('.faq-item');
            faqItem.classList.toggle('active');
        };

        // ---------- UTILS ----------
        function closeAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.classList.remove('active');
            });
            State.currentListDetail = null;
        }

        // ---------- EXPOSE GLOBALLY ----------
        window.State = State;
        window.switchTab = switchTab;
        window.switchToChat = switchToChat;
        window.setLanguage = setLanguage;
        window.openLanguageModal = openLanguageModal;
        window.closeLanguageModal = closeLanguageModal;
        window.selectLanguage = selectLanguage;
        window.applyLanguage = applyLanguage;
        window.toggleTheme = toggleTheme;
        window.toggleFaq = toggleFaq;
        window.stopVoiceRecording = stopVoiceRecording;
        window.showToast = showToast;
        window.viewShoppingListDetails = viewShoppingListDetails;
        window.closeListDetailModal = closeListDetailModal;
        window.togglePurchase = togglePurchase;
        window.startEditingItem = startEditingItem;
        window.saveEditedItem = saveEditedItem;
        window.cancelEditing = cancelEditing;
        window.deleteItemFromList = deleteItemFromList;
        window.shareShoppingList = shareShoppingList;
        window.openSharedListManual = openSharedListManual;
        window.clearShoppingList = clearShoppingList;
        window.submitExpense = submitExpense;
        window.viewAnalyticsFromExpense = viewAnalyticsFromExpense;
        window.cancelExpensePrompt = cancelExpensePrompt;
    </script>
</body>
</html>
